<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inkognitos Forum ‚Äî Telefonbuch ¬∑ Notizen ¬∑ F√§lle ¬∑ Chat</title>
  <meta name="description" content="Inkognitos Forum: Login-gesch√ºtztes Dashboard mit Rollen, Telefonbuch, Notizen, F√§llen, Chat (Base64) und Admin-Loginprotokoll. Firestore-only.">
  <style>
    :root{
      /* neue lila/dunkel Palette */
      --bg:#0b0914; --bg2:#120e1f;
      --glass:rgba(26,20,39,0.65); --glass2:rgba(20,15,32,0.6);
      --border:rgba(255,255,255,.12); --text:#e6e0f9; --muted:#a49bbd;
      --accent:#9b5dff; --accent2:#6d28d9; --vio1:#7c3aed; --vio2:#a78bfa;
      --ok:#22c55e; --danger:#ef4444; --warn:#f59e0b;
      --radius:18px; --gap:14px; --maxw:1280px;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0; font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Roboto,Arial,sans-serif; color:var(--text);
      background:
        radial-gradient(900px 600px at 20% 10%, rgba(124,58,237,.25), transparent 60%),
        radial-gradient(1200px 800px at 80% 90%, rgba(167,139,250,.18), transparent 60%),
        linear-gradient(180deg, var(--bg2), var(--bg));
      overflow-x:hidden;
    }

    /* Splash + Login */
    .splash{position:fixed; inset:0; display:grid; place-items:center; background:
      radial-gradient(1000px 700px at 50% 40%, rgba(124,58,237,.25), transparent 60%),
      linear-gradient(180deg,#0e0a18,#0b0914); z-index:50}
    .splash .box{text-align:center}
    .splash h2{margin:0; font-size:clamp(1.6rem,4vw,2.6rem)}
    .splash.fadeout{animation:splashout .7s cubic-bezier(.2,1,.2,1) forwards}
    @keyframes splashout{to{opacity:0; transform:scale(1.02); visibility:hidden}}
    .dot{display:inline-block; width:0.6ch; text-align:left; opacity:0}
    @keyframes blink{0%,20%{opacity:0}40%,100%{opacity:1}}
    .dot1{animation:blink 1.2s infinite}.dot2{animation:blink 1.2s infinite .2s}.dot3{animation:blink 1.2s infinite .4s}

    .login-overlay{position:fixed; inset:0; display:grid; place-items:center; backdrop-filter:blur(10px); background:rgba(10,6,18,.55); z-index:40}
    .login-card{width:min(420px,92vw); border-radius:20px; padding:18px}

    /* Background blobs */
    .blob{position:fixed; filter:blur(48px); opacity:.45; z-index:-2; animation:float 22s ease-in-out infinite}
    .b1{top:-160px; left:-200px; width:560px; height:560px; background:radial-gradient(circle at 30% 30%, rgba(155,93,255,.45), transparent 60%)}
    .b2{bottom:-180px; right:-240px; width:620px; height:620px; background:radial-gradient(circle at 70% 70%, rgba(109,40,217,.35), transparent 60%); animation-delay:-8s}
    .b3{top:45%; left:60%; width:420px; height:420px; background:radial-gradient(circle at 40% 60%, rgba(167,139,250,.30), transparent 60%); animation-delay:-3s}
    @keyframes float{0%,100%{transform:translate(0,0) scale(1)}50%{transform:translate(14px,-22px) scale(1.04)}}
    @media (prefers-reduced-motion: reduce){ .blob{animation:none} }

    /* Layout / Sidebar */
    .app{display:grid; grid-template-columns:300px 1fr; min-height:100dvh}
    @media (max-width:1024px){ .app{grid-template-columns:1fr} }
    .hamburger{display:none; position:fixed; top:14px; left:14px; z-index:10; width:46px; height:46px; border-radius:14px; border:1px solid var(--border); background:var(--glass2); backdrop-filter:blur(12px); cursor:pointer}
    .hamburger span, .hamburger::before, .hamburger::after{content:""; position:absolute; left:12px; right:12px; height:2px; background:#efe9ff; border-radius:2px; transition:.24s cubic-bezier(.2,1,.2,1)}
    .hamburger span{top:22px} .hamburger::before{top:14px} .hamburger::after{top:30px}
    @media (max-width:1024px){ .hamburger{display:block} }

    .sidebar{position:sticky; top:0; align-self:start; height:100dvh; padding:18px;
      backdrop-filter:blur(22px) saturate(120%); -webkit-backdrop-filter:blur(22px) saturate(120%);
      background:linear-gradient(180deg, var(--glass), var(--glass2)); border-right:1px solid var(--border)}
    .brand{display:flex; gap:12px; align-items:center; margin-bottom:16px}
    .logo{width:46px; height:46px; border-radius:16px;
      background:conic-gradient(from 210deg, #9b5dff, #6d28d9, #9b5dff);
      display:grid; place-items:center; color:#0b0914; font-weight:900; box-shadow:0 10px 24px rgba(155,93,255,.35)}
    .brand h1{margin:0; font-size:1.24rem}
    .nav{display:grid; gap:10px; margin-top:12px}
    .nav button{all:unset; display:flex; align-items:center; gap:10px; padding:12px 14px; border-radius:14px; cursor:pointer; color:var(--text); border:1px solid transparent}
    .nav button:hover{background:rgba(255,255,255,.06); border-color:rgba(255,255,255,.14)}
    .nav button.active{background:linear-gradient(135deg, rgba(155,93,255,.25), rgba(109,40,217,.22)); border-color:rgba(255,255,255,.22)}
    @media (max-width:1024px){
      .sidebar{position:fixed; left:-100%; width:min(320px,90vw); transition:left .26s cubic-bezier(.2,.9,.2,1); box-shadow:0 16px 40px rgba(0,0,0,.5)}
      .sidebar.open{left:0} .app{grid-template-columns:1fr}
    }

    .main{padding:24px; max-width:var(--maxw); width:100%; margin:0 auto}
    .glass{background:var(--glass); border:1px solid var(--border); border-radius:var(--radius);
      backdrop-filter: blur(16px) saturate(120%); -webkit-backdrop-filter: blur(16px) saturate(120%);
      box-shadow:0 12px 30px rgba(0,0,0,.45)}
    .section{padding:16px; margin-bottom:16px}

    /* Inputs/Buttons */
    input, button, textarea{font:inherit}
    input:not([type="file"]):not([type="checkbox"]):not([type="radio"]),
    input[type="search"], textarea, select{
      background:rgba(255,255,255,.07) !important; color:var(--text) !important;
      border:1px solid rgba(255,255,255,.18) !important; border-radius:14px !important;
      padding:12px 14px !important; outline:none !important; backdrop-filter:blur(8px) !important;
      -webkit-appearance:none; appearance:none;
    }
    input:focus, textarea:focus, select:focus{border-color:var(--accent) !important; box-shadow:0 0 0 4px rgba(155,93,255,.18) !important}
    ::placeholder{color:#c4b9e6}
    textarea{min-height:120px; resize:vertical}

    /* NICHT transparent: fette liquid Buttons */
    .btn{display:inline-grid; place-items:center; padding:12px 16px; border-radius:999px; color:white; font-weight:800;
      cursor:pointer; user-select:none; border:none; position:relative; isolation:isolate;
      transition:transform .24s cubic-bezier(.2,1.2,.2,1), filter .2s}
    .btn.primary{
      background:linear-gradient(135deg, #9b5dff 0%, #6d28d9 100%);
      box-shadow:0 8px 22px rgba(155,93,255,.35), inset 0 0 18px rgba(255,255,255,.06);
    }
    .btn.ghost{
      background:linear-gradient(135deg, #4b2e83 0%, #2d1b55 100%);
      box-shadow:0 6px 18px rgba(109,40,217,.28), inset 0 0 12px rgba(255,255,255,.05);
      color:#efe9ff; border:1px solid rgba(255,255,255,.12);
    }
    .btn.danger{
      background:linear-gradient(135deg, #ef4444, #b91c1c);
      box-shadow:0 8px 18px rgba(239,68,68,.35);
    }
    .btn:active{transform:scale(.97)}
    .pill{padding:8px 12px; border-radius:999px; background:rgba(155,93,255,.15); border:1px solid rgba(255,255,255,.16)}

    /* Tables/general */
    .row{display:grid; grid-template-columns:1fr 1fr 1fr auto; gap:var(--gap)}
    @media (max-width:900px){ .row{grid-template-columns:1fr 1fr} }
    @media (max-width:560px){ .row{grid-template-columns:1fr} }
    table{width:100%; border-collapse:separate; border-spacing:0}
    thead th{position:sticky; top:0; background:rgba(23,18,35,.7); backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px); z-index:1}
    th, td{padding:12px 10px; text-align:left; border-bottom:1px solid rgba(255,255,255,.08)}
    tbody tr{transition:background .15s}
    tbody tr:hover{background:rgba(255,255,255,.05)}
    .actions{display:flex; gap:8px}
    .muted{color:var(--muted)} .hidden{display:none !important}
    .fade-in{animation:fade .34s cubic-bezier(.2,.9,.2,1)} @keyframes fade{from{opacity:0; transform:translateY(8px) scale(.995)} to{opacity:1; transform:translateY(0) scale(1)}}
  </style>
</head>
<body>
  <!-- blobs -->
  <div class="blob b1"></div><div class="blob b2"></div><div class="blob b3"></div>

  <!-- startup sound -->
  <audio id="startupAudio" src="mm.ogg" preload="auto" playsinline></audio>

  <!-- splash -->
  <div class="splash" id="splash">
    <div class="box">
      <h2>Willkommen</h2>
      <div class="muted" style="margin-top:.35rem">Inkognitos Forum wird geladen
        <span class="dot dot1">.</span><span class="dot dot2">.</span><span class="dot dot3">.</span>
      </div>
    </div>
  </div>

  <!-- login overlay -->
  <div class="login-overlay" id="loginOverlay">
    <div class="glass login-card">
      <div class="brand" style="margin-bottom:8px">
        <div class="logo">IF</div>
        <div><h1>Inkognitos Forum</h1></div>
      </div>
      <div class="muted" id="loginInfo">Bitte einloggen, um das Forum zu sehen.</div>
      <div style="display:grid; gap:10px; margin-top:12px">
        <input id="authEmail" placeholder="Email" autocomplete="username" />
        <input id="authPass" placeholder="Passwort" type="password" autocomplete="current-password" />
        <button id="btnSignIn" class="btn primary">Login</button>
        <div id="authStatus" class="muted"></div>
      </div>
    </div>
  </div>

  <!-- hamburger -->
  <button class="hamburger" id="hamburger" aria-label="Men√º √∂ffnen"><span></span></button>

  <!-- app -->
  <div class="app hidden" id="appRoot">
    <!-- Sidebar -->
    <aside class="sidebar glass" id="sidebar" aria-label="Navigation">
      <div class="brand">
        <div class="logo">IF</div>
        <div>
          <h1>Inkognitos Forum</h1>
          <div class="muted"><span id="userBadge">‚Äî</span> ¬∑ <span id="roleBadge">‚Äî</span></div>
        </div>
      </div>

      <nav class="nav" id="nav">
        <button data-page="contacts" class="active">üìá Telefonbuch</button>
        <button data-page="notes">üóíÔ∏è Notizen</button>
        <button data-page="cases">üïµÔ∏è‚Äç‚ôÇÔ∏è F√§lle</button>
        <button data-page="chat" id="chatNav" class="hidden">üí¨ Chat</button>
        <button data-page="admin" id="adminNav" class="hidden">üõ°Ô∏è Admin</button>
        <button id="btnSignOut" class="btn ghost" style="margin-top:10px">Logout</button>
      </nav>
    </aside>

    <!-- Main -->
    <main class="main">
      <!-- Kontakte -->
      <section id="page-contacts" class="fade-in">
        <header class="glass section" style="display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap">
          <div style="display:flex; gap:10px; align-items:center">
            <input id="search" type="search" placeholder="Suche: Name, Nummer, Notiz‚Ä¶" aria-label="Suche" />
            <span class="pill">Sortieren</span>
            <button class="btn ghost" data-sort="name" title="Nach Name sortieren">Name</button>
            <button class="btn ghost" data-sort="phone" title="Nach Nummer sortieren">Telefon</button>
          </div>
          <div style="display:flex; gap:10px">
            <button id="exportContacts" class="btn primary" title="Export JSON">Export (lokal)</button>
            <label for="importContactsFile" style="display:inline-grid">
              <input id="importContactsFile" type="file" accept="application/json" class="hidden" />
              <button id="importContacts" class="btn primary">Import (lokal)</button>
            </label>
            <button id="clearContacts" class="btn danger" title="Alle Eintr√§ge l√∂schen">Alles l√∂schen</button>
          </div>
        </header>

        <section class="glass section">
          <h2 style="margin:0 0 8px 0">Kontakt hinzuf√ºgen</h2>
          <div class="row">
            <label> Name <input id="name" placeholder="Anna M√ºller" autocomplete="name" /></label>
            <label> Telefon <input id="phone" placeholder="+49 176 1234567" inputmode="tel" /></label>
            <label> Notiz <input id="note" placeholder="z. B. Schule" /></label>
            <div style="display:grid;align-content:end"><button id="addContact" class="btn primary">Hinzuf√ºgen</button></div>
          </div>
        </section>

        <section class="glass section" style="overflow:auto; max-height:60vh">
          <table aria-label="Kontaktliste">
            <thead><tr><th>Name</th><th>Telefon</th><th>Notiz</th><th>Aktionen</th></tr></thead>
            <tbody id="contactsBody"></tbody>
          </table>
        </section>
      </section>

      <!-- Notizen -->
      <section id="page-notes" class="hidden fade-in">
        <section class="glass section">
          <h2 style="margin:0 0 8px 0">Neue Notiz</h2>
          <div class="row" style="grid-template-columns:1fr 1fr auto">
            <label>Titel <input id="noteTitle" placeholder="z. B. Einkaufsliste" /></label>
            <label>Tags <input id="noteTags" placeholder="z. B. Schule, Projekt" /></label>
            <div style="display:grid;align-content:end"><button id="addNote" class="btn primary">Speichern</button></div>
          </div>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:var(--gap); margin-top:var(--gap)">
            <label style="display:block">Bild (optional)
              <input id="noteImage" type="file" accept="image/*" />
            </label>
            <label style="display:block">Text
              <textarea id="noteText" placeholder="Schreibe deine Notiz‚Ä¶"></textarea>
            </label>
          </div>
          <div class="muted" style="margin-top:6px">Bilder sind Base64 im Dokument (Demo). F√ºr gro√üe Mengen lieber extern hosten.</div>
        </section>

        <section class="glass section" style="overflow:auto; max-height:60vh">
          <table aria-label="Notizliste">
            <thead><tr><th>Titel</th><th>Tags</th><th>Bild</th><th>Aktionen</th></tr></thead>
            <tbody id="notesBody"></tbody>
          </table>
        </section>
      </section>

      <!-- F√§lle -->
      <section id="page-cases" class="hidden fade-in">
        <section class="glass section">
          <h2 style="margin:0 0 8px 0">Neuer Fall</h2>
          <div class="row" style="grid-template-columns:1fr 1fr 1fr auto">
            <label>Titel <input id="caseTitle" placeholder="z. B. Diebstahl im Park" /></label>
            <label>Aktenzeichen <input id="caseNumber" placeholder="z. B. 2025-001" /></label>
            <label>Status <input id="caseStatus" placeholder="z. B. offen/erledigt" /></label>
            <div style="display:grid;align-content:end"><button id="addCase" class="btn primary">Anlegen</button></div>
          </div>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:var(--gap); margin-top:var(--gap)">
            <label>Personen/Beteiligte <input id="casePeople" placeholder="Namen, Rollen" /></label>
            <label>Tags <input id="caseTags" placeholder="Tatort, Kategorie‚Ä¶" /></label>
          </div>
          <div style="margin-top:var(--gap)">
            <label>Beschreibung
              <textarea id="caseDesc" placeholder="Kurzbeschreibung des Falls‚Ä¶"></textarea>
            </label>
          </div>
        </section>

        <section class="glass section" style="overflow:auto; max-height:60vh">
          <table aria-label="F√§lle">
            <thead><tr><th>Aktenzeichen</th><th>Titel</th><th>Status</th><th>Aktionen</th></tr></thead>
            <tbody id="casesBody"></tbody>
          </table>
        </section>
      </section>

      <!-- Chat (rechte/admin) -->
      <section id="page-chat" class="hidden fade-in">
        <section class="glass section">
          <h2 style="margin:0 0 8px 0">Team-Chat</h2>
          <div id="chatList" style="display:flex; flex-direction:column; gap:10px; max-height:50vh; overflow:auto; padding-right:6px"></div>
        </section>
        <section class="glass section" style="display:grid; gap:10px">
          <textarea id="chatText" placeholder="Nachricht schreiben‚Ä¶ (Enter = Senden, Shift+Enter = Zeilenumbruch)" style="min-height:70px"></textarea>
          <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
            <label class="btn ghost" style="display:inline-grid">
              <input id="chatFile" type="file" accept="image/*,application/pdf" class="hidden" />
              Datei/Bild anh√§ngen
            </label>
            <div id="chatFileName" class="muted">Keine Datei</div>
            <button id="chatSend" class="btn primary">Senden</button>
          </div>
          <div class="muted" style="font-size:.9rem">Hinweis: Upload-Limit ~2 MB pro Nachricht (Base64 in Firestore).</div>
        </section>
      </section>

      <!-- Admin -->
      <section id="page-admin" class="hidden fade-in">
        <section class="glass section">
          <h2 style="margin:0 0 8px 0">Admin ‚Äî Nutzerverwaltung</h2>
          <div class="muted" style="margin-bottom:8px">Rollen bearbeiten, sperren/entsperren, (soft) l√∂schen. Login-Protokoll siehe unten.</div>

          <!-- Userliste -->
          <section class="glass section" style="overflow:auto; max-height:45vh">
            <table aria-label="Benutzerliste">
              <thead><tr><th>Email / Name</th><th>Rolle</th><th>Status</th><th>Aktionen</th></tr></thead>
              <tbody id="usersBody"></tbody>
            </table>
          </section>

          <!-- Login-Protokoll -->
          <section class="glass section" style="margin-top:12px">
            <h3 style="margin:0 0 8px 0">Login-Protokoll</h3>
            <div class="muted" style="margin-bottom:8px">Nur f√ºr Admin sichtbar ‚Äì Zeit, E-Mail, IP & User-Agent (gek√ºrzt).</div>
            <table aria-label="Login-Logs" style="width:100%">
              <thead>
                <tr><th>Zeit</th><th>E-Mail</th><th>IP</th><th>User-Agent</th><th>UID</th></tr>
              </thead>
              <tbody id="loginBody"></tbody>
            </table>
          </section>
        </section>
      </section>
    </main>
  </div>

  <!-- Firebase SDKs (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- Firebase Init -->
  <script id="firebase-init">
    const firebaseConfig = {
      apiKey: "AIzaSyBN60Xp5JfDZVHPQeUH4ZnGS9eZf1ebscM",
      authDomain: "datenbankrp.firebaseapp.com",
      projectId: "datenbankrp",
      storageBucket: "datenbankrp.firebasestorage.app", /* wird nicht genutzt */
      messagingSenderId: "334767405699",
      appId: "1:334767405699:web:d8d3ec72401b69d113f9b6"
    };
    const app = firebase.apps.length ? firebase.app() : firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();
    window.auth = auth; window.db = db;
  </script>

  <!-- App Code -->
  <script>
    // Splash
    function playStartup(){ try{ const a=document.getElementById('startupAudio'); a && a.play().catch(()=>{});}catch(e){} }
    function hideSplash(){ const s=document.getElementById('splash'); if(s){ s.classList.add('fadeout'); setTimeout(()=>s.remove(),700);} }
    setTimeout(()=>{ playStartup(); }, 2000);
    setTimeout(hideSplash, 3000);
    window.addEventListener('pointerdown', ()=>playStartup(), {once:true});

    // Helpers
    const $ = (s,r=document)=>r.querySelector(s);
    const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));
    const esc = s => (s==null?'':String(s)).replace(/[&<>\"']/g, ch=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[ch]));
    const readAsDataURL=f=>new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(f); });

    let currentUser=null, role='user', disabled=false;
    let unsubContacts=null,unsubNotes=null,unsubCases=null,unsubChat=null,unsubUsers=null,unsubLogins=null;

    // ===== AUTH & ACCESS =====
    async function loadProfile(uid){
      const ref = db.collection('profiles').doc(uid);
      const snap = await ref.get();
      if(!snap.exists){
        await ref.set({ display_name: currentUser.email || 'User', role: 'user', disabled: false });
        return { display_name: currentUser.email || 'User', role:'user', disabled:false };
      }
      return snap.data();
    }
    function applyAccessUI(){
      $('#userBadge').textContent = currentUser?.email || '‚Äî';
      $('#roleBadge').textContent = role + (disabled?' (gesperrt)':'');
      $('#adminNav').classList.toggle('hidden', !(role==='admin'));
      $('#chatNav').classList.toggle('hidden', !(role==='admin' || role==='rechte'));
      const ok = !!currentUser && !disabled;
      $('#appRoot').classList.toggle('hidden', !ok);
      $('#loginOverlay').classList.toggle('hidden', ok);
    }

    // Login-Log
    async function logLoginEvent(user){
      try{
        let ip=''; try{ const r=await fetch('https://api.ipify.org?format=json'); ip=(await r.json()).ip||''; }catch(e){}
        await db.collection('audit_logins').add({
          uid: user.uid, email: user.email || '', ip, ua: navigator.userAgent || '',
          ts: firebase.firestore.FieldValue.serverTimestamp()
        });
      }catch(e){ console.error('Login-Log fehlgeschlagen', e); }
    }

    // login
    $('#btnSignIn').addEventListener('click', async ()=>{
      const email=$('#authEmail').value.trim(), pass=$('#authPass').value.trim();
      $('#authStatus').textContent='Anmeldung‚Ä¶';
      try{
        const cred = await auth.signInWithEmailAndPassword(email, pass);
        currentUser = cred.user;
        const prof = await loadProfile(currentUser.uid);
        role = prof.role || 'user'; disabled = !!prof.disabled;
        if(disabled){ $('#authStatus').textContent='Konto gesperrt. Wende dich an den Admin.'; await auth.signOut(); return; }

        await logLoginEvent(currentUser);

        $('#authStatus').textContent='Angemeldet.';
        startSubscriptions();
        applyAccessUI();
      }catch(err){ console.error(err); $('#authStatus').textContent='Login fehlgeschlagen.'; }
    });

    $('#btnSignOut').addEventListener('click', async ()=>{
      [unsubContacts,unsubNotes,unsubCases,unsubChat,unsubUsers,unsubLogins].forEach(fn=>fn&&fn());
      await auth.signOut(); currentUser=null; role='user'; disabled=false;
      ['contactsBody','notesBody','casesBody','chatList','usersBody','loginBody'].forEach(id=>{ const el=document.getElementById(id); if(el) el.innerHTML=''; });
      applyAccessUI();
    });

    let _loginLoggedOnce = false;
    auth.onAuthStateChanged(async (user)=>{
      if(user){
        currentUser=user;
        const prof=await loadProfile(user.uid);
        role = prof.role || 'user'; disabled=!!prof.disabled;
        if(disabled){ await auth.signOut(); return; }
        if(!_loginLoggedOnce){ _loginLoggedOnce=true; logLoginEvent(user); }
        startSubscriptions();
        applyAccessUI();
      }else{
        currentUser=null; role='user'; disabled=false; applyAccessUI();
      }
    });

    // ===== SUBSCRIPTIONS =====
    function startSubscriptions(){
      // Contacts
      if(unsubContacts) unsubContacts();
      unsubContacts = (role==='admin'
        ? db.collection('contacts').orderBy('name')
        : db.collection('contacts').where('owner','==', currentUser.uid).orderBy('name')
      ).onSnapshot(snap=>{
        const tbody=$('#contactsBody'); tbody.innerHTML='';
        snap.forEach(doc=>{ const c=doc.data();
          const tr=document.createElement('tr');
          tr.innerHTML=`<td>${esc(c.name)}</td><td><a href="tel:${encodeURIComponent(c.phone)}" style="color:#c6abff">${esc(c.phone)}</a></td><td>${esc(c.note||'')}</td>
            <td class="actions">${actionBtns('contact',doc.id,c)}</td>`;
          tbody.appendChild(tr);
        });
      });

      // Notes
      if(unsubNotes) unsubNotes();
      unsubNotes = (role==='admin'
        ? db.collection('notes').orderBy('updated_at','desc')
        : db.collection('notes').where('owner','==', currentUser.uid).orderBy('updated_at','desc')
      ).onSnapshot(snap=>{
        const tbody=$('#notesBody'); tbody.innerHTML='';
        snap.forEach(doc=>{ const n=doc.data();
          const thumb=n.image?`<img src="${n.image}" alt="Bild" style="width:64px;height:64px;object-fit:cover;border-radius:12px;border:1px solid var(--border)"/>`:'<span class="muted">‚Äì</span>';
          const tr=document.createElement('tr');
          tr.innerHTML=`<td>${esc(n.title||'Ohne Titel')}</td><td>${esc(n.tags||'')}</td><td>${thumb}</td>
            <td class="actions">${actionBtns('note',doc.id,n)}</td>`;
          tbody.appendChild(tr);
        });
      });

      // Cases
      if(unsubCases) unsubCases();
      unsubCases = (role==='admin'
        ? db.collection('cases').orderBy('updated_at','desc')
        : db.collection('cases').where('owner','==', currentUser.uid).orderBy('updated_at','desc')
      ).onSnapshot(snap=>{
        const tbody=$('#casesBody'); tbody.innerHTML='';
        snap.forEach(doc=>{ const c=doc.data();
          const tr=document.createElement('tr');
          tr.innerHTML=`<td>${esc(c.number||'‚Äî')}</td><td>${esc(c.title||'')}</td><td>${esc(c.status||'')}</td>
            <td class="actions">${actionBtns('case',doc.id,c)}</td>`;
          tbody.appendChild(tr);
        });
      });

      // Chat (rechte/admin)
      if(unsubChat) unsubChat();
      if(role==='admin' || role==='rechte'){
        unsubChat = db.collection('chatMessages').orderBy('ts','asc').limit(500).onSnapshot(snap=>{
          const list=$('#chatList'); list.innerHTML='';
          snap.forEach(doc=>{
            const m=doc.data();
            const item=document.createElement('div');
            item.className='glass'; item.style.cssText='padding:10px;border-radius:14px';
            const file = m.imageData
              ? (m.mime?.startsWith('image/') 
                  ? `<div style="margin-top:6px"><img src="${m.imageData}" alt="${esc(m.fileName||'Bild')}" style="max-width:100%;border-radius:12px;border:1px solid var(--border)"/></div>`
                  : `<div><a href="${m.imageData}" download="${esc(m.fileName||'datei')}" style="color:#c6abff">Datei herunterladen</a></div>`)
              : '';
            item.innerHTML = `<div style="display:flex;justify-content:space-between;gap:8px">
                <strong>${esc(m.display_name||m.uid)}</strong>
                <span class="muted">${new Date(m.ts?.seconds? m.ts.seconds*1000 : Date.now()).toLocaleString()}</span>
              </div>
              <div style="white-space:pre-wrap;margin-top:4px">${esc(m.text||'')}</div>
              ${file}`;
            list.appendChild(item);
            list.scrollTop = list.scrollHeight;
          });
        });
      }

      // Admin: list users (profiles)
      if(unsubUsers) unsubUsers();
      if(role==='admin'){
        unsubUsers = db.collection('profiles').orderBy('display_name').onSnapshot(snap=>{
          const tbody=$('#usersBody'); tbody.innerHTML='';
          snap.forEach(doc=>{
            const u=doc.data(); const id=doc.id;
            const tr=document.createElement('tr');
            tr.innerHTML = `
              <td>${esc(u.display_name||'‚Äî')}</td>
              <td>
                <select data-act="set-role" data-id="${id}">
                  <option value="user" ${u.role==='user'?'selected':''}>user</option>
                  <option value="rechte" ${u.role==='rechte'?'selected':''}>rechte</option>
                  <option value="admin" ${u.role==='admin'?'selected':''}>admin</option>
                </select>
              </td>
              <td>
                <label class="pill">gesperrt:
                  <input type="checkbox" data-act="toggle-disabled" data-id="${id}" ${u.disabled?'checked':''} style="margin-left:8px;transform:translateY(1px)">
                </label>
              </td>
              <td class="actions">
                <button class="btn danger" data-act="soft-delete" data-id="${id}">Soft l√∂schen</button>
              </td>`;
            tbody.appendChild(tr);
          });
        });

        // Login-Logs
        if(unsubLogins) unsubLogins();
        unsubLogins = db.collection('audit_logins')
          .orderBy('ts','desc').limit(500)
          .onSnapshot(snap=>{
            const tbody = $('#loginBody'); if(!tbody) return;
            tbody.innerHTML = '';
            snap.forEach(doc=>{
              const x = doc.data();
              const when = x.ts?.seconds ? new Date(x.ts.seconds*1000) : new Date();
              const ua = (x.ua || '').slice(0,40) + ((x.ua||'').length>40?'‚Ä¶':'');
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td>${when.toLocaleString()}</td>
                <td>${esc(x.email||'')}</td>
                <td>${esc(x.ip||'')}</td>
                <td>${esc(ua)}</td>
                <td class="muted" title="${esc(x.uid||'')}">${esc((x.uid||'').slice(0,8))}‚Ä¶</td>`;
              tbody.appendChild(tr);
            });
          });
      }
    }

    // ===== CRUD helpers =====
    async function addContactFS(n,p,nt){ if(!currentUser) return alert('Bitte einloggen.'); await db.collection('contacts').add({ owner: currentUser.uid, name:n, phone:p, note:nt, updated_at: firebase.firestore.FieldValue.serverTimestamp() }); }
    async function addNoteFS(title,tags,text,image){ if(!currentUser) return alert('Bitte einloggen.'); await db.collection('notes').add({ owner: currentUser.uid, title, tags, text, image, updated_at: firebase.firestore.FieldValue.serverTimestamp() }); }
    async function addCaseFS(obj){ if(!currentUser) return alert('Bitte einloggen.'); await db.collection('cases').add({ owner: currentUser.uid, ...obj, images:[], interrogations:[], updated_at: firebase.firestore.FieldValue.serverTimestamp() }); }

    function actionBtns(type,id,obj){
      const canEdit = role==='admin' || (currentUser && obj.owner===currentUser.uid);
      const edit = canEdit? `<button class="btn ghost" data-act="edit" data-type="${type}" data-id="${id}">Bearbeiten</button>`:'';
      const del = canEdit? `<button class="btn danger" data-act="del" data-type="${type}" data-id="${id}">L√∂schen</button>`:'';
      const open = type==='note'? `<button class="btn ghost" data-act="open-note" data-id="${id}">√ñffnen</button>` :
                   type==='case'? `<button class="btn ghost" data-act="open-case" data-id="${id}">√ñffnen</button>` : '';
      return [open, edit, del].filter(Boolean).join('');
    }

    // ===== UI Events =====
    $('#hamburger').addEventListener('click',()=>$('#sidebar').classList.toggle('open'));
    $$('#nav button').forEach(btn=>btn.addEventListener('click',()=>switchPage(btn.dataset.page)));
    function switchPage(page){
      $$('#nav button').forEach(b=>b.classList.toggle('active', b.dataset.page===page));
      ['contacts','notes','cases','chat','admin'].forEach(p=>{
        const el=document.getElementById('page-'+p); if(!el) return; el.classList.toggle('hidden', p!==page);
      });
    }

    // Contacts
    $('#addContact').addEventListener('click', async ()=>{
      const n=$('#name').value, p=$('#phone').value, nt=$('#note').value;
      if(!n.trim()) return alert('Bitte Namen eingeben.'); if(!p.trim()) return alert('Bitte Telefonnummer eingeben.');
      await addContactFS(n.trim(),p.trim(),nt.trim());
      $('#name').value=$('#phone').value=$('#note').value='';
    });
    $('#search').addEventListener('input',e=>{
      const q=e.target.value.toLowerCase(); $$('#contactsBody tr').forEach(tr=>{ tr.style.display = tr.textContent.toLowerCase().includes(q)? '' : 'none'; });
    });

    document.addEventListener('click', async (e)=>{
      const btn = e.target.closest('button'); if(!btn) return;
      const act=btn.dataset.act; const type=btn.dataset.type; const id=btn.dataset.id;

      if(act==='del'){ if(!confirm('Eintrag l√∂schen?')) return; await db.collection(type+'s').doc(id).delete(); }

      if(act==='edit' && type==='contact'){
        const tr=btn.closest('tr'); const tds=tr.querySelectorAll('td');
        const [nameTd, phoneTd, noteTd] = tds; const name=nameTd.textContent.trim(); const phone=phoneTd.textContent.trim(); const note=noteTd.textContent.trim();
        tr.innerHTML = `<td><input id="e_name" value="${esc(name)}"/></td>
                        <td><input id="e_phone" value="${esc(phone)}"/></td>
                        <td><input id="e_note" value="${esc(note)}"/></td>
                        <td class="actions"><button class="btn primary" data-act="save-contact" data-id="${id}">Speichern</button>
                        <button class="btn danger" data-act="cancel-edit">Abbrechen</button></td>`;
      }
      if(act==='save-contact'){
        const tr=btn.closest('tr');
        const n=tr.querySelector('#e_name').value.trim(); const p=tr.querySelector('#e_phone').value.trim(); const nt=tr.querySelector('#e_note').value.trim();
        if(!n||!p) return alert('Name/Telefon erforderlich');
        await db.collection('contacts').doc(id).update({ name:n, phone:p, note:nt, updated_at: firebase.firestore.FieldValue.serverTimestamp() });
      }

      if(act==='open-note'){ const doc = await db.collection('notes').doc(id).get(); openNoteModal(doc.data()); }
      if(act==='open-case'){ const doc = await db.collection('cases').doc(id).get(); openCaseModalFS(id, doc.data()); }

      if(act==='soft-delete'){ if(!confirm('Profil (soft) l√∂schen?')) return; await db.collection('profiles').doc(id).delete(); alert('Profil-Dokument gel√∂scht. Auth-Konto bleibt bestehen.'); }
    });

    // Admin: role/disabled changes
    document.addEventListener('change', async (e)=>{
      const sel = e.target.closest('select[data-act="set-role"]');
      const chk = e.target.closest('input[data-act="toggle-disabled"]');
      if(sel){ await db.collection('profiles').doc(sel.dataset.id).update({ role: sel.value }); }
      if(chk){ await db.collection('profiles').doc(chk.dataset.id).update({ disabled: chk.checked }); }
    });

    // Notes add
    $('#addNote').addEventListener('click', async ()=>{
      const title=$('#noteTitle').value; const tags=$('#noteTags').value; const text=$('#noteText').value;
      const f=$('#noteImage').files[0]; let image=''; if(f){ try{ image=await readAsDataURL(f);}catch{} }
      if(!title.trim() && !text.trim() && !image) return alert('Bitte mindestens Titel, Text oder Bild angeben.');
      await addNoteFS(title.trim(),tags.trim(),text.trim(),image);
      $('#noteTitle').value=$('#noteTags').value=$('#noteText').value=''; $('#noteImage').value='';
    });

    // Note modal
    function openNoteModal(n){
      const modal=document.createElement('div'); modal.className='glass fade-in';
      modal.style.cssText='position:fixed;inset:0;display:grid;place-items:center;background:rgba(12,8,20,.55);padding:20px;z-index:40';
      const box=document.createElement('div'); box.className='glass'; box.style.cssText='max-width:920px;width:95vw;border-radius:20px;padding:18px;';
      box.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
        <h3 style="margin:0">${esc(n.title||'Ohne Titel')}</h3><button id="closeModal" class="btn ghost">Schlie√üen</button></div>
        <div class="muted" style="margin:.25rem 0">${esc(n.tags||'')}</div>
        <div style="display:grid;grid-template-columns:300px 1fr;gap:14px;margin-top:12px">
          <div>${n.image?`<img src="${n.image}" alt="Bild" style="width:100%;border-radius:16px;border:1px solid var(--border);object-fit:cover"/>`:'<div class="muted">Kein Bild</div>'}</div>
          <div style="white-space:pre-wrap">${esc(n.text||'')}</div>
        </div>`;
      modal.appendChild(box);
      modal.addEventListener('click',e=>{ if(e.target===modal||e.target.id==='closeModal') modal.remove();});
      document.body.appendChild(modal);
    }

    // Cases modal
    function openCaseModalFS(id,c){
      const modal=document.createElement('div'); modal.className='glass fade-in';
      modal.style.cssText='position:fixed;inset:0;display:grid;place-items:center;background:rgba(12,8,20,.55);padding:20px;z-index:40';
      const box=document.createElement('div'); box.className='glass'; box.style.cssText='max-width:1000px;width:96vw;border-radius:20px;padding:18px;';
      box.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h3 style="margin:0">${esc(c.title)} <span class="pill" style="margin-left:8px">${esc(c.number)}</span></h3>
          <button id="closeCase" class="btn ghost">Schlie√üen</button>
        </div>
        <div class="muted" style="margin:.3rem 0">Status: ${esc(c.status||'‚Äî')} ¬∑ Tags: ${esc(c.tags||'‚Äî')}</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:12px">
          <div>
            <h4>Beteiligte</h4>
            <div class="glass" style="padding:10px;border-radius:14px">${esc(c.people||'‚Äî')}</div>
            <h4 style="margin-top:12px">Beschreibung</h4>
            <div class="glass" style="padding:10px;border-radius:14px;white-space:pre-wrap">${esc(c.desc||'‚Äî')}</div>
          </div>
          <div>
            <h4>Verh√∂re</h4>
            <div id="interroList" class="glass" style="padding:10px;border-radius:14px;max-height:220px;overflow:auto">
              ${(c.interrogations||[]).map(x=>`<div style='border-bottom:1px solid rgba(255,255,255,.08);padding:6px 0'><strong>${esc(x.when)}</strong><div style='white-space:pre-wrap'>${esc(x.text)}</div></div>`).join('') || '<div class="muted">Keine Eintr√§ge</div>'}
            </div>
            <div style="display:grid;grid-template-columns:1fr auto;gap:8px;margin-top:10px">
              <input id="interroText" placeholder="Verh√∂rnotiz‚Ä¶"/>
              <button id="addInterro" class="btn primary">Hinzuf√ºgen</button>
            </div>
            <h4 style="margin-top:12px">Bilder</h4>
            <div id="imgWrap" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px">
              ${(c.images||[]).map(u=>`<img src='${u}' alt='Bild' style='width:100%;height:90px;object-fit:cover;border-radius:12px;border:1px solid var(--border)'/>`).join('')}
            </div>
            <label class="btn primary" style="margin-top:8px;display:inline-grid">
              <input id="caseImgInput" type="file" accept="image/*" class="hidden"/>Bild anh√§ngen
            </label>
          </div>
        </div>`;
      modal.appendChild(box);
      modal.addEventListener('click',e=>{ if(e.target===modal||e.target.id==='closeCase'){ modal.remove(); }});

      box.querySelector('#addInterro').addEventListener('click',async ()=>{
        const t=box.querySelector('#interroText').value.trim(); if(!t) return;
        const entry={when:new Date().toLocaleString(), text:t};
        const updated=[entry, ...(c.interrogations||[])];
        await db.collection('cases').doc(id).update({ interrogations: updated, updated_at: firebase.firestore.FieldValue.serverTimestamp() });
        modal.remove(); const doc=await db.collection('cases').doc(id).get(); openCaseModalFS(id, doc.data());
      });
      box.querySelector('#caseImgInput').addEventListener('change', async (e)=>{
        const f=e.target.files&&e.target.files[0]; if(!f) return;
        const url=await readAsDataURL(f);
        const updated=[...(c.images||[]), url];
        await db.collection('cases').doc(id).update({ images: updated, updated_at: firebase.firestore.FieldValue.serverTimestamp() });
        modal.remove(); const doc=await db.collection('cases').doc(id).get(); openCaseModalFS(id, doc.data());
      });

      document.body.appendChild(modal);
    }

    // Chat
    $('#chatFile').addEventListener('change', (e)=>{
      const f=e.target.files && e.target.files[0];
      $('#chatFileName').textContent = f ? `${f.name} (${Math.round(f.size/1024)} KB)` : 'Keine Datei';
    });
    $('#chatText').addEventListener('keydown', (e)=>{
      if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); $('#chatSend').click(); }
    });
    $('#chatSend').addEventListener('click', async ()=>{
      if(!(role==='admin' || role==='rechte')) return alert('Kein Chat-Zugriff.');
      const text=$('#chatText').value.trim(); const file=$('#chatFile').files[0];

      let imageData='', fileName='', mime='';
      if(file){
        if(file.size > 2*1024*1024){ alert('Datei zu gro√ü (max ~2 MB).'); return; }
        imageData = await readAsDataURL(file); fileName = file.name; mime = file.type || 'application/octet-stream';
      }
      if(!text && !imageData) return;

      await db.collection('chatMessages').add({
        uid: currentUser.uid, display_name: currentUser.email || 'User', role, text, imageData, fileName, mime,
        ts: firebase.firestore.FieldValue.serverTimestamp()
      });
      $('#chatText').value=''; $('#chatFile').value=''; $('#chatFileName').textContent='Keine Datei';
    });
  </script>
</body>
</html>
