<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard ‚Äî Telefonbuch ¬∑ Notizen ¬∑ F√§lle</title>
  <meta name="description" content="Telefonbuch, Notizen und F√§lle mit Login und Firestore‚ÄëSync. Apple-orientiertes Dark-Blue-Glass UI. Splash 3s, Startsound bei 2s. Kostenlos mit Firebase (Auth + Firestore)." />
  <style>
    :root{
      --bg:#0b1220; --bg2:#0a101c; --glass:rgba(10,16,28,.55); --glass2:rgba(12,18,32,.45);
      --border:rgba(255,255,255,.12); --text:#e9eef6; --muted:#a6b0c3;
      --accent:#0a84ff; --accent2:#5ac8fa; --ok:#22c55e; --danger:#ef4444; --warn:#f59e0b;
      --radius:18px; --gap:14px; --maxw:1280px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Roboto,Arial,sans-serif; color:var(--text);
      background:radial-gradient(1400px 900px at 15% 10%, #0f1a2f 0%, var(--bg2) 55%, #070c16 100%); overflow-x:hidden}

    /* Splash */
    .splash{position:fixed; inset:0; display:grid; place-items:center; background:radial-gradient(1400px 900px at 50% 40%, #0f1a2f 0%, #091222 70%); z-index:50}
    .splash .box{text-align:center}
    .splash h2{margin:0; font-size:clamp(1.6rem,4vw,2.6rem)}
    .splash.fadeout{animation:splashout .7s cubic-bezier(.2,1,.2,1) forwards}
    @keyframes splashout{to{opacity:0; transform:scale(1.02); visibility:hidden}}
    .dot{display:inline-block; width:0.6ch; text-align:left; opacity:0}
    @keyframes blink{0%,20%{opacity:0}40%,100%{opacity:1}}
    .dot1{animation:blink 1.2s infinite}
    .dot2{animation:blink 1.2s infinite .2s}
    .dot3{animation:blink 1.2s infinite .4s}

    /* Background blobs */
    .blob{position:fixed; filter:blur(48px); opacity:.5; z-index:-2; animation:float 22s ease-in-out infinite}
    .b1{top:-160px; left:-200px; width:560px; height:560px; background:radial-gradient(circle at 30% 30%, rgba(10,132,255,.65), transparent 60%)}
    .b2{bottom:-180px; right:-240px; width:620px; height:620px; background:radial-gradient(circle at 70% 70%, rgba(90,200,250,.55), transparent 60%); animation-delay:-8s}
    .b3{top:45%; left:60%; width:420px; height:420px; background:radial-gradient(circle at 40% 60%, rgba(72,149,239,.45), transparent 60%); animation-delay:-3s}
    @keyframes float{0%,100%{transform:translate(0,0) scale(1)}50%{transform:translate(14px,-22px) scale(1.04)}}
    @media (prefers-reduced-motion: reduce){ .blob{animation:none} }

    .app{display:grid; grid-template-columns:300px 1fr; min-height:100dvh}
    @media (max-width:1024px){ .app{grid-template-columns:1fr} }

    .hamburger{display:none; position:fixed; top:14px; left:14px; z-index:10; width:46px; height:46px; border-radius:14px; border:1px solid var(--border); background:var(--glass2); backdrop-filter:blur(12px); cursor:pointer}
    .hamburger span, .hamburger::before, .hamburger::after{content:""; position:absolute; left:12px; right:12px; height:2px; background:#e9eef6; border-radius:2px; transition:.24s cubic-bezier(.2,1,.2,1)}
    .hamburger span{top:22px}
    .hamburger::before{top:14px}
    .hamburger::after{top:30px}
    @media (max-width:1024px){ .hamburger{display:block} }

    .sidebar{position:sticky; top:0; align-self:start; height:100dvh; padding:18px; backdrop-filter:blur(22px) saturate(120%); -webkit-backdrop-filter:blur(22px) saturate(120%);
      background:linear-gradient(180deg, var(--glass), var(--glass2)); border-right:1px solid var(--border)}
    .brand{display:flex; gap:12px; align-items:center; margin-bottom:16px}
    .logo{width:46px; height:46px; border-radius:16px; background:linear-gradient(135deg,#0a84ff,#5ac8fa); display:grid; place-items:center; color:#061120; font-weight:900; box-shadow:0 8px 24px rgba(2,6,23,.35)}
    .brand h1{margin:0; font-size:1.24rem}

    .nav{display:grid; gap:10px; margin-top:12px}
    .nav button{all:unset; display:flex; align-items:center; gap:10px; padding:12px 14px; border-radius:14px; cursor:pointer; color:var(--text); border:1px solid transparent}
    .nav button:hover{background:rgba(255,255,255,.06); border-color:rgba(255,255,255,.14)}
    .nav button.active{background:linear-gradient(135deg, rgba(10,132,255,.22), rgba(90,200,250,.18)); border-color:rgba(255,255,255,.22)}

    .main{padding:24px; max-width:var(--maxw); width:100%; margin:0 auto}
    .glass{background:var(--glass); border:1px solid var(--border); border-radius:var(--radius); backdrop-filter: blur(16px) saturate(120%); -webkit-backdrop-filter: blur(16px) saturate(120%); box-shadow: 0 10px 30px rgba(0,0,0,.45)}
    .section{padding:16px; margin-bottom:16px}

    input, button, textarea{font:inherit}
    input:not([type="file"]):not([type="checkbox"]):not([type="radio"]),
    input[type="search"], textarea, select{
      background:rgba(255,255,255,.06) !important; color:var(--text) !important; border:1px solid rgba(255,255,255,.18) !important; border-radius:14px !important; padding:12px 14px !important; outline:none !important; backdrop-filter:blur(8px) !important; -webkit-appearance:none; appearance:none
    }
    input:focus, textarea:focus, select:focus{border-color:var(--accent) !important; box-shadow:0 0 0 4px rgba(10,132,255,.18) !important}
    ::placeholder{color:#aab4c6}
    textarea{min-height:120px; resize:vertical}

    .btn{display:inline-grid; place-items:center; padding:12px 16px; border-radius:999px; color:white; font-weight:800; cursor:pointer; user-select:none; border:none; position:relative; isolation:isolate; transition:transform .24s cubic-bezier(.2,1.2,.2,1), filter .2s}
    .btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent2)); box-shadow:0 6px 18px rgba(10,132,255,.35)}
    .btn.ghost{background:linear-gradient(135deg, rgba(255,255,255,.18), rgba(255,255,255,.12)); color:#e9eef6; border:1px solid rgba(255,255,255,.16)}
    .btn.danger{background:linear-gradient(135deg, rgba(239,68,68,.9), rgba(239,68,68,.7))}
    .btn:active{transform:scale(.97)}

    .pill{padding:8px 12px; border-radius:999px; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.16)}
    .row{display:grid; grid-template-columns:1fr 1fr 1fr auto; gap:var(--gap)}
    @media (max-width:900px){ .row{grid-template-columns:1fr 1fr} }
    @media (max-width:560px){ .row{grid-template-columns:1fr} }

    table{width:100%; border-collapse:separate; border-spacing:0}
    thead th{position:sticky; top:0; background:rgba(13,19,32,.7); backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px); z-index:1}
    th, td{padding:12px 10px; text-align:left; border-bottom:1px solid rgba(255,255,255,.08)}
    tbody tr{transition:background .15s}
    tbody tr:hover{background:rgba(255,255,255,.05)}
    .actions{display:flex; gap:8px}

    .muted{color:var(--muted)}
    .hidden{display:none !important}
    .fade-in{animation:fade .34s cubic-bezier(.2,.9,.2,1)}
    @keyframes fade{from{opacity:0; transform:translateY(8px) scale(.995)} to{opacity:1; transform:translateY(0) scale(1)}}
  </style>
</head>
<body>
  <!-- background blobs -->
  <div class="blob b1"></div>
  <div class="blob b2"></div>
  <div class="blob b3"></div>

  <!-- Startup sound: place mm.ogg neben index.html -->
  <audio id="startupAudio" src="mm.ogg" preload="auto" playsinline></audio>

  <!-- Splash welcome -->
  <div class="splash" id="splash">
    <div class="box">
      <h2>Willkommen</h2>
      <div class="muted" style="margin-top:.35rem">Dashboard wird geladen<span class="dot dot1">.</span><span class="dot dot2">.</span><span class="dot dot3">.</span></div>
    </div>
  </div>

  <button class="hamburger" id="hamburger" aria-label="Men√º √∂ffnen"><span></span></button>

  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar glass" id="sidebar" aria-label="Navigation">
      <div class="brand">
        <div class="logo">DB</div>
        <div>
          <h1>Dashboard</h1>
          <div class="muted">Login + Sync (Firebase)</div>
        </div>
      </div>

      <!-- Auth Box -->
      <div id="authBox" class="glass" style="padding:12px;border-radius:14px;display:grid;gap:8px;margin-bottom:12px">
        <div id="authWhenSignedOut">
          <input id="authEmail" placeholder="Email" />
          <input id="authPass" placeholder="Passwort" type="password" />
          <div style="display:flex;gap:8px;margin-top:6px">
            <button id="btnSignIn" class="btn primary" style="width:100%">Login</button>
          </div>
          <div class="muted" style="margin-top:6px;font-size:.9rem">Noch kein Account? Frag den Admin.</div>
        </div>
        <div id="authWhenSignedIn" class="hidden">
          <div style="display:flex;align-items:center;gap:8px">
            <div class="pill" id="userBadge">‚Äî</div>
            <div class="muted" id="roleBadge">user</div>
          </div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="btnSignOut" class="btn ghost" style="width:100%">Logout</button>
          </div>
        </div>
        <div id="authStatus" class="muted"></div>
      </div>

      <nav class="nav" id="nav">
        <button data-page="contacts" class="active">üìá Telefonbuch</button>
        <button data-page="notes">üóíÔ∏è Notizen</button>
        <button data-page="cases">üïµÔ∏è‚Äç‚ôÇÔ∏è F√§lle</button>
        <button data-page="links">üîó N√ºtzliche Websites</button>
        <button data-page="admin" id="adminNav" class="hidden">üõ°Ô∏è Admin</button>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="main">
      <!-- Contacts Page -->
      <section id="page-contacts" class="fade-in">
        <header class="glass section" style="display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap">
          <div style="display:flex; gap:10px; align-items:center">
            <input id="search" type="search" placeholder="Suche: Name, Nummer, Notiz‚Ä¶" aria-label="Suche" />
            <span class="pill">Sortieren</span>
            <button class="btn ghost" data-sort="name" title="Nach Name sortieren">Name</button>
            <button class="btn ghost" data-sort="phone" title="Nach Nummer sortieren">Telefon</button>
          </div>
          <div style="display:flex; gap:10px">
            <button id="exportContacts" class="btn primary" title="Export JSON">Export (lokal)</button>
            <label for="importContactsFile" style="display:inline-grid"><input id="importContactsFile" type="file" accept="application/json" class="hidden" /><button id="importContacts" class="btn primary">Import (lokal)</button></label>
            <button id="clearContacts" class="btn danger" title="Alle Eintr√§ge l√∂schen">Alles l√∂schen</button>
          </div>
        </header>

        <section class="glass section">
          <h2 style="margin:0 0 8px 0">Kontakt hinzuf√ºgen</h2>
          <div class="row">
            <label> Name <input id="name" placeholder="Anna M√ºller" autocomplete="name" /></label>
            <label> Telefon <input id="phone" placeholder="+49 176 1234567" inputmode="tel" /></label>
            <label> Notiz <input id="note" placeholder="z. B. Schule" /></label>
            <div style="display:grid;align-content:end"><button id="addContact" class="btn primary">Hinzuf√ºgen</button></div>
          </div>
        </section>

        <section class="glass section" style="overflow:auto; max-height:60vh">
          <table aria-label="Kontaktliste">
            <thead>
              <tr><th>Name</th><th>Telefon</th><th>Notiz</th><th>Aktionen</th></tr>
            </thead>
            <tbody id="contactsBody"></tbody>
          </table>
        </section>
      </section>

      <!-- Notes Page -->
      <section id="page-notes" class="hidden fade-in">
        <section class="glass section">
          <h2 style="margin:0 0 8px 0">Neue Notiz</h2>
          <div class="row" style="grid-template-columns:1fr 1fr auto">
            <label>Titel <input id="noteTitle" placeholder="z. B. Einkaufsliste" /></label>
            <label>Tags <input id="noteTags" placeholder="z. B. Schule, Projekt" /></label>
            <div style="display:grid;align-content:end"><button id="addNote" class="btn primary">Speichern</button></div>
          </div>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:var(--gap); margin-top:var(--gap)">
            <label style="display:block">Bild (optional)
              <input id="noteImage" type="file" accept="image/*" />
            </label>
            <label style="display:block">Text
              <textarea id="noteText" placeholder="Schreibe deine Notiz‚Ä¶"></textarea>
            </label>
          </div>
          <div class="muted" style="margin-top:6px">Kleiner Hinweis: Bilder werden im Dokument Base64 gespeichert (f√ºr Demo). F√ºr gro√üe Bilder lieber Cloud Storage nutzen.</div>
        </section>

        <section class="glass section" style="overflow:auto; max-height:60vh">
          <table aria-label="Notizliste">
            <thead>
              <tr><th>Titel</th><th>Tags</th><th>Bild</th><th>Aktionen</th></tr>
            </thead>
            <tbody id="notesBody"></tbody>
          </table>
        </section>
      </section>

      <!-- Cases Page (KriPo) -->
      <section id="page-cases" class="hidden fade-in">
        <section class="glass section">
          <h2 style="margin:0 0 8px 0">Neuer Fall</h2>
          <div class="row" style="grid-template-columns:1fr 1fr 1fr auto">
            <label>Titel <input id="caseTitle" placeholder="z. B. Diebstahl im Park" /></label>
            <label>Aktenzeichen <input id="caseNumber" placeholder="z. B. 2025-001" /></label>
            <label>Status <input id="caseStatus" placeholder="z. B. offen/erledigt" /></label>
            <div style="display:grid;align-content:end"><button id="addCase" class="btn primary">Anlegen</button></div>
          </div>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:var(--gap); margin-top:var(--gap)">
            <label>Personen/Beteiligte <input id="casePeople" placeholder="Namen, Rollen" /></label>
            <label>Tags <input id="caseTags" placeholder="Tatort, Kategorie‚Ä¶" /></label>
          </div>
          <div style="margin-top:var(--gap)">
            <label>Beschreibung
              <textarea id="caseDesc" placeholder="Kurzbeschreibung des Falls‚Ä¶"></textarea>
            </label>
          </div>
        </section>

        <section class="glass section" style="overflow:auto; max-height:60vh">
          <table aria-label="F√§lle">
            <thead>
              <tr><th>Aktenzeichen</th><th>Titel</th><th>Status</th><th>Aktionen</th></tr>
            </thead>
            <tbody id="casesBody"></tbody>
          </table>
        </section>
      </section>

      <!-- Useful Links -->
      <section id="page-links" class="hidden fade-in">
        <section class="glass section">
          <h2 style="margin:0 0 12px 0">N√ºtzliche Websites</h2>
          <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px">
            <a class="glass" href="https://www.bka.de/DE/Home/home_node.html" target="_blank" style="padding:14px;border-radius:16px;text-decoration:none;color:inherit">
              <div class="pill">BKA</div><div style="margin-top:6px">Bundeskriminalamt</div>
            </a>
            <a class="glass" href="https://www.gesetze-im-internet.de/stgb/" target="_blank" style="padding:14px;border-radius:16px;text-decoration:none;color:inherit">
              <div class="pill">StGB</div><div style="margin-top:6px">Strafgesetzbuch (Gesetze im Internet)</div>
            </a>
            <a class="glass" href="https://www.bundespolizei.de" target="_blank" style="padding:14px;border-radius:16px;text-decoration:none;color:inherit">
              <div class="pill">Bundespolizei</div><div style="margin-top:6px">Offizielle Website</div>
            </a>
            <a class="glass" href="https://www.wikipedia.org" target="_blank" style="padding:14px;border-radius:16px;text-decoration:none;color:inherit">
              <div class="pill">Wikipedia</div><div style="margin-top:6px">Recherche & Grundlagen</div>
            </a>
            <a class="glass" href="https://www.deepl.com/translator" target="_blank" style="padding:14px;border-radius:16px;text-decoration:none;color:inherit">
              <div class="pill">DeepL</div><div style="margin-top:6px">√úbersetzungen</div>
            </a>
            <a class="glass" href="https://www.zeit.de" target="_blank" style="padding:14px;border-radius:16px;text-decoration:none;color:inherit">
              <div class="pill">ZEIT</div><div style="margin-top:6px">Nachrichten & Dossiers</div>
            </a>
          </div>
        </section>
      </section>

      <!-- Admin Page (nur sichtbar f√ºr Admin) -->
      <section id="page-admin" class="hidden fade-in">
        <section class="glass section">
          <h2 style="margin:0 0 8px 0">Admin ‚Äî Nutzerverwaltung</h2>
          <div class="muted" style="margin-bottom:8px">Als Admin kannst du hier neue Logins erstellen und Rollen setzen. (Client-seitig mit <em>Secondary Firebase App</em>, Session bleibt erhalten.)</div>
          <div class="row" style="grid-template-columns:1fr 1fr 1fr auto">
            <label>Email <input id="newUserEmail" placeholder="nutzer@beispiel.de" /></label>
            <label>Passwort <input id="newUserPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" type="password" /></label>
            <label>Rolle
              <select id="newUserRole">
                <option value="user">user</option>
                <option value="admin">admin</option>
              </select>
            </label>
            <div style="display:grid;align-content:end"><button id="btnCreateUser" class="btn primary">Nutzer anlegen</button></div>
          </div>
          <div id="adminMsg" class="muted" style="margin-top:8px"></div>
        </section>
      </section>
    </main>
  </div>

  <!-- Firebase SDKs (v9 compat for simplicity) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // ===== Splash Sound Timeline =====
    function playStartup(){ try{ const a=document.getElementById('startupAudio'); a && a.play().catch(()=>{}); }catch(e){} }
    function hideSplash(){ const s=document.getElementById('splash'); if(s){ s.classList.add('fadeout'); setTimeout(()=>s.remove(),700);} }
    setTimeout(()=>{ playStartup(); }, 2000); // 2s
    setTimeout(hideSplash, 3000);             // 3s
    window.addEventListener('pointerdown', ()=>playStartup(), {once:true}); // fallback

    // ===== Firebase Config (PLACEHOLDER ‚Äî eintragen!) =====
    const firebaseConfig = {
      apiKey: "PASTE_YOUR_API_KEY",
      authDomain: "PASTE_YOUR_PROJECT.firebaseapp.com",
      projectId: "PASTE_YOUR_PROJECT",
      storageBucket: "PASTE_YOUR_PROJECT.appspot.com",
      messagingSenderId: "PASTE_SENDER_ID",
      appId: "PASTE_APP_ID"
    };

    // Init primary app
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Helper UI
    const $ = (s,r=document)=>r.querySelector(s);
    const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));
    const uid = ()=>Math.random().toString(36).slice(2,10);

    // App state
    let currentUser = null;
    let isAdmin = false;
    let unsubContacts = null, unsubNotes = null, unsubCases = null;

    function setSignedInUI(user, admin){
      currentUser = user; isAdmin = !!admin;
      $('#authWhenSignedOut').classList.toggle('hidden', !!user);
      $('#authWhenSignedIn').classList.toggle('hidden', !user);
      $('#adminNav').classList.toggle('hidden', !admin);
      if(user){
        $('#userBadge').textContent = user.email || user.uid;
        $('#roleBadge').textContent = admin? 'admin' : 'user';
      }
    }

    // Profiles: store role
    async function ensureProfile(user){
      const ref = db.collection('profiles').doc(user.uid);
      const snap = await ref.get();
      if(!snap.exists){ await ref.set({ display_name: user.email || 'User', role: 'user' }); }
      return (await ref.get()).data();
    }

    async function checkIsAdmin(user){
      const ref = db.collection('profiles').doc(user.uid);
      const data = (await ref.get()).data();
      return data && data.role === 'admin';
    }

    // Auth
    $('#btnSignIn').addEventListener('click', async ()=>{
      const email=$('#authEmail').value.trim();
      const pass=$('#authPass').value.trim();
      $('#authStatus').textContent='Anmeldung‚Ä¶';
      try{
        const cred = await auth.signInWithEmailAndPassword(email, pass);
        await ensureProfile(cred.user);
        const admin = await checkIsAdmin(cred.user);
        setSignedInUI(cred.user, admin);
        subscribeData();
        $('#authStatus').textContent='Angemeldet.';
      }catch(err){ console.error(err); $('#authStatus').textContent='Login fehlgeschlagen.'; }
    });

    $('#btnSignOut').addEventListener('click', async ()=>{
      try{
        if(unsubContacts) unsubContacts(); if(unsubNotes) unsubNotes(); if(unsubCases) unsubCases();
        await auth.signOut(); setSignedInUI(null,false);
        $('#contactsBody').innerHTML=''; $('#notesBody').innerHTML=''; $('#casesBody').innerHTML='';
        $('#authStatus').textContent='Abgemeldet.';
      }catch(err){ console.error(err); }
    });

    auth.onAuthStateChanged(async (user)=>{
      if(user){ await ensureProfile(user); const admin=await checkIsAdmin(user); setSignedInUI(user,admin); subscribeData(); }
      else { setSignedInUI(null,false); }
    });

    // ===== Data (Firestore) =====
    function subscribeData(){
      if(!currentUser) return;
      // Contacts
      if(unsubContacts) unsubContacts();
      unsubContacts = db.collection('contacts')
        .where(isAdmin? 'id' : 'owner','!=', null) // workaround to allow where queries; replaced below
        .onSnapshot(()=>{}); // dummy to keep reference
      // Proper queries
      if(isAdmin){
        unsubContacts = db.collection('contacts').orderBy('name').onSnapshot(renderContactsFromSnap);
      }else{
        unsubContacts = db.collection('contacts').where('owner','==', currentUser.uid).orderBy('name').onSnapshot(renderContactsFromSnap);
      }

      // Notes
      if(unsubNotes) unsubNotes();
      if(isAdmin){ unsubNotes = db.collection('notes').orderBy('updated_at','desc').onSnapshot(renderNotesFromSnap); }
      else { unsubNotes = db.collection('notes').where('owner','==', currentUser.uid).orderBy('updated_at','desc').onSnapshot(renderNotesFromSnap); }

      // Cases
      if(unsubCases) unsubCases();
      if(isAdmin){ unsubCases = db.collection('cases').orderBy('updated_at','desc').onSnapshot(renderCasesFromSnap); }
      else { unsubCases = db.collection('cases').where('owner','==', currentUser.uid).orderBy('updated_at','desc').onSnapshot(renderCasesFromSnap); }
    }

    // Renderers from snapshots
    function renderContactsFromSnap(snap){ const tbody=$('#contactsBody'); tbody.innerHTML=''; snap.forEach(doc=>{ const c=doc.data(); tbody.appendChild(contactRow(doc.id,c)); }); }
    function renderNotesFromSnap(snap){ const tbody=$('#notesBody'); tbody.innerHTML=''; snap.forEach(doc=>{ const n=doc.data(); tbody.appendChild(noteRow(doc.id,n)); }); }
    function renderCasesFromSnap(snap){ const tbody=$('#casesBody'); tbody.innerHTML=''; snap.forEach(doc=>{ const c=doc.data(); tbody.appendChild(caseRow(doc.id,c)); }); }

    // Row creators
    function contactRow(id,c){ const tr=document.createElement('tr'); tr.innerHTML=`<td>${escape(c.name)}</td><td><a href="tel:${encodeURIComponent(c.phone)}" style="color:var(--accent)">${escape(c.phone)}</a></td><td>${escape(c.note||'')}</td><td class="actions">${actionBtns('contact',id,c)}</td>`; return tr; }
    function noteRow(id,n){ const tr=document.createElement('tr'); const thumb=n.image?`<img src="${n.image}" alt="Bild" style="width:64px;height:64px;object-fit:cover;border-radius:12px;border:1px solid var(--border)"/>`:'<span class="muted">‚Äì</span>'; tr.innerHTML=`<td>${escape(n.title||'Ohne Titel')}</td><td>${escape(n.tags||'')}</td><td>${thumb}</td><td class="actions">${actionBtns('note',id,n)}</td>`; return tr; }
    function caseRow(id,c){ const tr=document.createElement('tr'); tr.innerHTML=`<td>${escape(c.number||'‚Äî')}</td><td>${escape(c.title||'')}</td><td>${escape(c.status||'')}</td><td class="actions">${actionBtns('case',id,c)}</td>`; return tr; }

    const escape = (s)=> (s==null?'':String(s)).replace(/[&<>"']/g, ch=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[ch]));

    function actionBtns(type,id,obj){
      const canEdit = isAdmin || (currentUser && obj.owner===currentUser.uid);
      const edit = canEdit? `<button class="btn ghost" data-act="edit" data-type="${type}" data-id="${id}">Bearbeiten</button>`:'';
      const del = canEdit? `<button class="btn danger" data-act="del" data-type="${type}" data-id="${id}">L√∂schen</button>`:'';
      const open = type==='note'? `<button class="btn ghost" data-act="open-note" data-id="${id}">√ñffnen</button>` : (type==='case'? `<button class="btn ghost" data-act="open-case" data-id="${id}">√ñffnen</button>` : '');
      return [open, edit, del].filter(Boolean).join('');
    }

    // Add handlers
    async function addContactFS(n,p,nt){ if(!currentUser) return alert('Bitte einloggen.'); await db.collection('contacts').add({ owner: currentUser.uid, name:n, phone:p, note:nt, updated_at: firebase.firestore.FieldValue.serverTimestamp() }); }
    async function addNoteFS(title,tags,text,image){ if(!currentUser) return alert('Bitte einloggen.'); await db.collection('notes').add({ owner: currentUser.uid, title, tags, text, image, updated_at: firebase.firestore.FieldValue.serverTimestamp() }); }
    async function addCaseFS(obj){ if(!currentUser) return alert('Bitte einloggen.'); await db.collection('cases').add({ owner: currentUser.uid, ...obj, images:[], interrogations:[], updated_at: firebase.firestore.FieldValue.serverTimestamp() }); }

    // DOM events (Contacts)
    $('#addContact').addEventListener('click', async ()=>{ const n=$('#name').value, p=$('#phone').value, nt=$('#note').value; if(!n.trim()) return alert('Bitte Namen eingeben.'); if(!p.trim()) return alert('Bitte Telefonnummer eingeben.'); await addContactFS(n.trim(),p.trim(),nt.trim()); $('#name').value=$('#phone').value=$('#note').value=''; });
    $('#search').addEventListener('input',e=>{ const q=e.target.value.toLowerCase(); $$('#contactsBody tr').forEach(tr=>{ tr.style.display = tr.textContent.toLowerCase().includes(q)? '' : 'none'; }); });
    $$('button[data-sort]').forEach(b=>b.addEventListener('click',()=>{ alert('Sortierung clientseitig ‚Äì f√ºr echte Sortierung bitte in Firestore orderBy anpassen.'); }));

    document.addEventListener('click', async (e)=>{
      const btn = e.target.closest('button'); if(!btn) return;
      const act=btn.dataset.act; const type=btn.dataset.type; const id=btn.dataset.id;
      // delete
      if(act==='del'){
        if(!confirm('Eintrag l√∂schen?')) return;
        await db.collection(type+'s').doc(id).delete();
      }
      // edit (inline for contacts)
      if(act==='edit' && type==='contact'){
        const tr=btn.closest('tr'); const tds=tr.querySelectorAll('td');
        const [nameTd, phoneTd, noteTd] = tds;
        const name=nameTd.textContent.trim(); const phone=phoneTd.textContent.trim(); const note=noteTd.textContent.trim();
        tr.innerHTML = `<td><input id="e_name" value="${escape(name)}"/></td><td><input id="e_phone" value="${escape(phone)}"/></td><td><input id="e_note" value="${escape(note)}"/></td><td class="actions"><button class="btn primary" data-act="save-contact" data-id="${id}">Speichern</button><button class="btn danger" data-act="cancel-edit">Abbrechen</button></td>`;
      }
      if(act==='save-contact'){
        const tr=btn.closest('tr'); const n=tr.querySelector('#e_name').value.trim(); const p=tr.querySelector('#e_phone').value.trim(); const nt=tr.querySelector('#e_note').value.trim(); if(!n||!p) return alert('Name/Telefon erforderlich'); await db.collection('contacts').doc(id).update({ name:n, phone:p, note:nt, updated_at: firebase.firestore.FieldValue.serverTimestamp() });
      }
      if(act==='cancel-edit'){ subscribeData(); }

      // notes open
      if(act==='open-note'){
        const doc = await db.collection('notes').doc(id).get(); const n=doc.data(); openNoteModal(n);
      }

      // cases open
      if(act==='open-case'){
        const doc = await db.collection('cases').doc(id).get(); const c=doc.data(); openCaseModalFS(id,c);
      }
    });

    // Notes add
    async function readAsDataURL(file){ return await new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }
    $('#addNote').addEventListener('click', async ()=>{ const title=$('#noteTitle').value; const tags=$('#noteTags').value; const text=$('#noteText').value; const f=$('#noteImage').files[0]; let image=''; if(f){ try{ image=await readAsDataURL(f);}catch{} } if(!title.trim() && !text.trim() && !image) return alert('Bitte mindestens Titel, Text oder Bild angeben.'); await addNoteFS(title.trim(),tags.trim(),text.trim(),image); $('#noteTitle').value=$('#noteTags').value=$('#noteText').value=''; $('#noteImage').value=''; });

    function openNoteModal(n){ const modal=document.createElement('div'); modal.className='glass fade-in'; modal.style.cssText='position:fixed;inset:0;display:grid;place-items:center;background:rgba(2,6,23,.55);padding:20px;z-index:40'; const box=document.createElement('div'); box.className='glass'; box.style.cssText='max-width:920px;width:95vw;border-radius:20px;padding:18px;'; box.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;gap:10px"><h3 style="margin:0">${escape(n.title||'Ohne Titel')}</h3><button id="closeModal" class="btn ghost">Schlie√üen</button></div><div class="muted" style="margin:.25rem 0">${escape(n.tags||'')}</div><div style="display:grid;grid-template-columns:300px 1fr;gap:14px;margin-top:12px"><div>${n.image?`<img src="${n.image}" alt="Bild" style="width:100%;border-radius:16px;border:1px solid var(--border);object-fit:cover"/>`:'<div class="muted">Kein Bild</div>'}</div><div style="white-space:pre-wrap">${escape(n.text||'')}</div></div>`; modal.appendChild(box); modal.addEventListener('click',e=>{ if(e.target===modal||e.target.id==='closeModal') modal.remove();}); document.body.appendChild(modal); }

    // Cases modal with Firestore update hooks
    function openCaseModalFS(id,c){ const modal=document.createElement('div'); modal.className='glass fade-in'; modal.style.cssText='position:fixed;inset:0;display:grid;place-items:center;background:rgba(2,6,23,.55);padding:20px;z-index:40'; const box=document.createElement('div'); box.className='glass'; box.style.cssText='max-width:1000px;width:96vw;border-radius:20px;padding:18px;'; box.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center"><h3 style="margin:0">${escape(c.title)} <span class="pill" style="margin-left:8px">${escape(c.number)}</span></h3><button id="closeCase" class="btn ghost">Schlie√üen</button></div><div class="muted" style="margin:.3rem 0">Status: ${escape(c.status||'‚Äî')} ¬∑ Tags: ${escape(c.tags||'‚Äî')}</div><div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:12px"><div><h4>Beteiligte</h4><div class="glass" style="padding:10px;border-radius:14px">${escape(c.people||'‚Äî')}</div><h4 style="margin-top:12px">Beschreibung</h4><div class="glass" style="padding:10px;border-radius:14px;white-space:pre-wrap">${escape(c.desc||'‚Äî')}</div></div><div><h4>Verh√∂re</h4><div id="interroList" class="glass" style="padding:10px;border-radius:14px;max-height:220px;overflow:auto">${(c.interrogations||[]).map(x=>`<div style='border-bottom:1px solid rgba(255,255,255,.08);padding:6px 0'><strong>${escape(x.when)}</strong><div style='white-space:pre-wrap'>${escape(x.text)}</div></div>`).join('') || '<div class="muted">Keine Eintr√§ge</div>'}</div><div style="display:grid;grid-template-columns:1fr auto;gap:8px;margin-top:10px"><input id="interroText" placeholder="Verh√∂rnotiz‚Ä¶"/><button id="addInterro" class="btn primary">Hinzuf√ºgen</button></div><h4 style="margin-top:12px">Bilder</h4><div id="imgWrap" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px">${(c.images||[]).map(u=>`<img src='${u}' alt='Bild' style='width:100%;height:90px;object-fit:cover;border-radius:12px;border:1px solid var(--border)'/>`).join('')}</div><label class="btn primary" style="margin-top:8px;display:inline-grid"><input id="caseImgInput" type="file" accept="image/*" class="hidden"/>Bild hochladen</label></div></div>`; modal.appendChild(box); modal.addEventListener('click',e=>{ if(e.target===modal||e.target.id==='closeCase'){ modal.remove(); }}); box.querySelector('#addInterro').addEventListener('click',async ()=>{ const t=box.querySelector('#interroText').value.trim(); if(!t) return; const entry={when:new Date().toLocaleString(), text:t}; const updated=[entry, ...(c.interrogations||[])]; await db.collection('cases').doc(id).update({ interrogations: updated, updated_at: firebase.firestore.FieldValue.serverTimestamp() }); modal.remove(); const doc=await db.collection('cases').doc(id).get(); openCaseModalFS(id, doc.data()); }); box.querySelector('#caseImgInput').addEventListener('change', async (e)=>{ const f=e.target.files&&e.target.files[0]; if(!f) return; const url=await readAsDataURL(f); const updated=[...(c.images||[]), url]; await db.collection('cases').doc(id).update({ images: updated, updated_at: firebase.firestore.FieldValue.serverTimestamp() }); modal.remove(); const doc=await db.collection('cases').doc(id).get(); openCaseModalFS(id, doc.data()); }); document.body.appendChild(modal); }

    // Add new case
    $('#addCase').addEventListener('click', async ()=>{ const obj={ title:$('#caseTitle').value.trim(), number:$('#caseNumber').value.trim(), status:$('#caseStatus').value.trim(), people:$('#casePeople').value.trim(), tags:$('#caseTags').value.trim(), desc:$('#caseDesc').value.trim() }; if(!obj.title||!obj.number) return alert('Titel und Aktenzeichen sind erforderlich.'); await addCaseFS(obj); $('#caseTitle').value=$('#caseNumber').value=$('#caseStatus').value=$('#casePeople').value=$('#caseTags').value=$('#caseDesc').value=''; });

    // Admin: create users via secondary app (keine Session-√úbernahme)
    $('#btnCreateUser').addEventListener('click', async ()=>{
      if(!currentUser || !isAdmin){ $('#adminMsg').textContent='Keine Admin-Rechte.'; return; }
      const email=$('#newUserEmail').value.trim(); const pass=$('#newUserPass').value.trim(); const role=$('#newUserRole').value;
      if(!email || !pass){ $('#adminMsg').textContent='Email/Passwort fehlen.'; return; }
      try{
        const secondary = firebase.initializeApp(firebaseConfig, 'Secondary');
        const secondaryAuth = secondary.auth();
        const cred = await secondaryAuth.createUserWithEmailAndPassword(email, pass);
        const newUid = cred.user.uid;
        await db.collection('profiles').doc(newUid).set({ display_name: email, role: role });
        await secondary.delete();
        $('#adminMsg').textContent='Nutzer angelegt: ' + email + ' (Rolle: ' + role + ')';
      }catch(err){ console.error(err); $('#adminMsg').textContent='Fehler beim Anlegen: ' + err.message; }
    });

    // Sidebar + pages
    $('#hamburger').addEventListener('click',()=>$('#sidebar').classList.toggle('open'));
    $$('#nav button').forEach(btn=>btn.addEventListener('click',()=>switchPage(btn.dataset.page)));
    function switchPage(page){
      $$('#nav button').forEach(b=>b.classList.toggle('active', b.dataset.page===page));
      ['contacts','notes','cases','links','admin'].forEach(p=>{
        const el=document.getElementById('page-'+p); if(!el) return; el.classList.toggle('hidden', p!==page);
      });
    }
  </script>

  <!-- ===== Firestore Security Rules (KOPIEREN in Firebase Console ‚Üí Firestore ‚Üí Rules) =====
  rules_version = '2';
  service cloud.firestore {
    match /databases/{database}/documents {
      // Profiles: each user can read/write eigenes Profil
      match /profiles/{userId} {
        allow read: if request.auth != null; // jeder eingeloggte darf Profile lesen (f√ºr Rollenanzeige)
        allow write: if request.auth != null && request.auth.uid == userId; // Nutzer darf eigenes Profil √§ndern
      }

      // Helper function to check admin flag
      function isAdmin() {
        return request.auth != null &&
               exists(/databases/$(database)/documents/profiles/$(request.auth.uid)) &&
               get(/databases/$(database)/documents/profiles/$(request.auth.uid)).data.role == 'admin';
      }

      // Contacts/Notes/Cases: owner kann eigene, Admin alles
      match /contacts/{docId} {
        allow read: if isAdmin() || (request.auth != null && resource.data.owner == request.auth.uid);
        allow create: if request.auth != null && request.resource.data.owner == request.auth.uid;
        allow update, delete: if isAdmin() || (request.auth != null && resource.data.owner == request.auth.uid);
      }
      match /notes/{docId} {
        allow read: if isAdmin() || (request.auth != null && resource.data.owner == request.auth.uid);
        allow create: if request.auth != null && request.resource.data.owner == request.auth.uid;
        allow update, delete: if isAdmin() || (request.auth != null && resource.data.owner == request.auth.uid);
      }
      match /cases/{docId} {
        allow read: if isAdmin() || (request.auth != null && resource.data.owner == request.auth.uid);
        allow create: if request.auth != null && request.resource.data.owner == request.auth.uid;
        allow update, delete: if isAdmin() || (request.auth != null && resource.data.owner == request.auth.uid);
      }
    }
  }
  ===== -->
</body>
</html>
